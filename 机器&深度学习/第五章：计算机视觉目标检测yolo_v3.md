### 单阶段目标检测模型YOLOv3


YOLOv3算法基本思想可以分成两部分：

- 按一定规则在图片上产生一系列的候选区域，然后根据这些候选区域与图片上物体真实框之间的位置关系对候选区域进行标注。跟真实框足够接近的那些候选区域会被标注为正样本，同时将真实框的位置作为正样本的位置目标。偏离真实框较大的那些候选区域则会被标注为负样本，负样本不需要预测位置或者类别。
- 使用卷积神经网络提取图片特征并对候选区域的位置和类别进行预测。这样每个预测框就可以看成是一个样本，根据真实框相对它的位置和类别进行了标注而获得标签值，通过网络模型预测其位置和类别，将网络预测值和标签值进行比较，就可以建立起损失函数。

YOLOv3算法预测过程的流程图如 图1 所示，预测图片经过一系列预处理(resize、normalization等)输入到YOLOv3模型，根据预先设定的Anchor和提取到的图片特征得到目标预测框，最后通过非极大值抑制(NMS)消除重叠较大的冗余预测框，得到最终预测结果。

![](./imgs/e92ba2985c474efa8e83b17289b0534c8ffc616cb8c3441c8d268936d90bc571.png)


YOLOv3网络结构大致分为3个部分：Backbone、Neck、Head，如 图2 所示:

![](./imgs/682c9a2807ed4b34b5ef575e56d4c629623c5e2d86a442b6b49d32decd1f821c.jpg)


- Backbone：骨干网络，主要用于特征提取
- Neck：在Backbone和Head之间提取不同阶段中特征图
- Head：检测头，用于预测目标的类别和位置


#### 产生候选区域


如何产生候选区域，是检测模型的核心设计方案。目前大多数基于卷积神经网络的模型所采用的方式大体如下：

- 按一定的规则在图片上生成一系列位置固定的锚框，将这些锚框看作是可能的候选区域。
- 对锚框是否包含目标物体进行预测，如果包含目标物体，还需要预测所包含物体的类别，以及预测框相对于锚框位置需要调整的幅度。

#### 生成锚框

将原始图片划分成m×n个区域，如下图所示，原始图片高度H=640, 宽度W=480，如果我们选择小块区域的尺寸为32×32则m和n分别为：

```math
m = \frac{640}{32} = 20
```
```math
n = \frac{480}{32} = 15
```

将原始图像分成了20行15列小方块区域。

![](./imgs/2dd1cbeb53644552a8cb38f3f834dbdda5046a489465454d93cdc88d1ce65ca5.png)

> 最上面的行号是第0行，最左边的列号是第0列

YOLOv3算法会在每个区域的中心，生成一系列锚框。为了展示方便，我们先在图中第十行第四列的小方块位置附近画出生成的锚框，如 图4 所示。

![](./imgs/6dd42b9138364a379b6231ac2247d3cb449d612e17be4896986bca2703acbb29.png)
> 图4：在第10行第4列的小方块区域生成3个锚框 

如下展示在每个区域附近都生成3个锚框，很多锚框堆叠在一起可能不太容易看清楚，但过程跟上面类似，只是需要以每个区域的中心点为中心，分别生成3个锚框。

![](./imgs/0880c3b5ec2d40edb476f4fcbadd87aa9f37059cd24d4a1a9d37c627ce5f618a.png)


#### 生成预测框

在前面已经指出，锚框的位置都是固定好的，不可能刚好跟物体边界框重合，需要在锚框的基础上进行位置的微调以生成预测框。预测框相对于锚框会有不同的中心位置和大小，采用什么方式能得到预测框呢？我们先来考虑如何生成其中心位置坐标。

比如上面图中在第10行第4列的小方块区域中心生成的一个锚框，如绿色虚线框所示。以小方格的宽度为单位长度，

此小方块区域左上角的位置坐标是：

```math
c_x = 4 \\
c_y = 10
```

此锚框的区域中心坐标是：

```math
center_x=c_x​+0.5=4.5 \\ 
center_y=c_y​+0.5=10.5 \\ 
```

可以通过下面的方式生成预测框的中心坐标：

```math
b_x = c_x + \sigma(t_x)
```