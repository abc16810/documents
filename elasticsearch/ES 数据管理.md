存储在Elasticsearch中的数据通常分为以下两类

- Content:要搜索的项目集合，例如产品目录
- 时间序列数据:连续生成的带有时间戳的数据流，例如日志条目

内容可能会经常更新，但内容的价值会随着时间的推移保持相对不变。您希望能够快速检索条目，而不管它们有多旧。

时间序列数据会随着时间的推移不断积累，因此需要一些策略来平衡数据的价值和存储数据的成本。随着它的老化，它往往变得不那么重要，访问频率也越来越低，因此您可以将它转移到成本更低、性能更低的硬件上。对于最旧的数据，重要的是您能够访问这些数据。如果查询需要更长的时间来完成，这是可以的

了帮助你管理你的数据，Elasticsearch使你能够:

- 定义具有不同性能特征的多层数据节点
- 根据您的性能需求和保留策略，使用索引生命周期管理(ILM)在数据层中自动转换索引
- 利用存储在远程存储库中的可搜索快照为旧索引提供弹性，同时降低操作成本并保持搜索性能。
- 对存储在性能较低的硬件上的数据执行异步搜索。

#### 数据层 (Data tiers)

据层是具有相同数据角色的节点的集合，它们通常共享相同的硬件配置文件:

- Content tier节点处理产品目录等内容的索引和查询负载。

- hot tier节点处理时间序列数据(如日志或指标)的索引负载，并保存最近、最频繁访问的数据。
- warm tier节点保存访问频率较低且很少需要更新的时间序列数据。
- cold tier节点保存的时间序列数据访问频率不高，通常也不会更新。为了节省空间，可以在冷层上保留可搜索快照的完整挂载索引。这些完全挂载的索引消除了对副本的需要，与常规索引相比，所需的磁盘空间减少了大约50%。
- frozen tier节点保存的时间序列数据很少被访问，也从不更新。冻结层只存储可搜索快照的部分挂载索引。这进一步扩展了存储容量-比warm层多达20倍。

当您将文档直接索引到特定索引时，它们将无限期地保留在内容层节点（content tier）上。

当您将文档索引到数据流时，它们最初驻留在热层节点上。您可以配置索引生命周期管理(ILM)策略，根据您的性能、弹性和数据保留需求，自动将时间序列数据在hot、warm和cold层之间转换。

节点的数据角色在elasticsearch.yml中配置。例如，集群中性能最高的节点可能被分配给 `hot and content tiers`:

```
node.roles: ["data_hot", "data_content"]  # 数据节点
# 默认不指定情况下为 roles [transform, data_frozen, master, remote_cluster_client, data, ml, data_content, data_hot, data_warm, data_cold, ingest] 所有角色
```

为每个数据节点配置适当的角色，将其分配给一个或多个数据层:data_hot、data_content、data_warm、data_cold或data_frozen。节点还可以有其他角色。默认情况下，新节点具有所有角色。



**Content tier**

存储在内容层的数据通常是一些项目的集合，比如产品目录或文章存档。与时间序列数据不同的是，内容的值随着时间的推移保持相对不变，因此随着时间的推移将其移动到具有不同性能特征的层是没有意义的。内容数据通常有较长的数据保留需求，您希望能够快速检索条目，而不管它们有多老。

内容层节点通常针对查询性能进行了优化——它们将处理能力置于IO吞吐量之上，以便能够处理复杂的搜索和聚合并快速返回结果。虽然它们也负责索引，但内容数据通常不会像时间序列数据(如日志和指标)那样以很高的速度被吸收。从弹性的角度来看，该层中的索引应该配置为使用一个或多个副本。

内容层是必需的。不属于数据流的系统索引和其他索引将自动分配给内容层。

**Hot tier**

hot层是时间序列数据的Elasticsearch入口点，保存最近的、最频繁搜索的时间序列数据。hot层的节点读写速度都需要达到一定的要求，从而需要更多的硬件资源和更快的ssd (storage)存储速度。对于弹性，应该将hot层中的索引配置为使用一个或多个副本

需要设置热层。作为数据流一部分的新索引将自动分配给hot层

**Warm tier**

如果时间序列数据的查询频率低于热层中最近建立索引的数据，那么它就可以转移到hot层。warm层通常保存着最近几周的数据。更新仍然是允许的，但可能不频繁。warm层中的节点通常不需要像hot层中的节点那样快。对于弹性，warm层中的索引应该配置为使用一个或多个副本

**Cold tier**

当您不再需要定期搜索时间序列数据时，它可以从暖层移动到cold层。虽然仍然可搜索，但这一层通常是为较低的存储成本而不是搜索速度而优化的。

为了更好地节省存储空间，可以将可搜索快照的完整挂载索引保存在冷层上。与常规索引不同，这些完全安装的索引不需要副本来保证可靠性。在发生故障时，它们可以从底层快照恢复数据。这可能会使数据所需的本地存储减少一半。快照存储库需要在冷层中使用完全挂载的索引。完全挂载的索引是只读的

或者，您可以使用cold层来存储带有副本的常规索引，而不是使用可搜索的快照。这使得您可以将较旧的数据存储在较便宜的硬件上，但与warm层相比，并不会减少所需的磁盘空间。

**Frozen tier**

一旦数据不再被查询，或者很少被查询，它可能会从cold层移动到frozen层，在那里它会一直待下去。

冻结层需要快照存储库。冻结层使用部分挂载的索引来存储和加载快照存储库中的数据。这减少了本地存储和操作成本，同时仍然允许您搜索冻结的数据。由于Elasticsearch有时必须从快照存储库中获取冻结的数据，因此在冻结层上的搜索通常比在冷层上的搜索慢。

建议您在冻结层中使用专用节点



#### 数据层索引分配

- 当你创建索引时，默认情况下Elasticsearch会设置`index.routing.allocation.include._tier_preference= data_content`来自动将索引碎片分配到内容层。

- 当Elasticsearch创建索引作为数据流的一部分时，默认情况下，Elasticsearch会设置`index.routing.allocation.include_tier_preference = data_hot`将索引分片自动分配到热层

您可以通过在创建索引请求或匹配新索引的索引模板中指定分片分配过滤设置来重写基于层的自动分配。

你也可以显式地设置`index.routing.allocation.include._tier_preference`选择不使用默认的基于层的分配。如果将层首选项设置为`null`, Elasticsearch会在分配时忽略数据层角色。

ILM使用migrate动作在可用的数据层中自动转换管理索引。默认情况下，在每个阶段都会自动注入此操作。您可以显式指定迁移操作以覆盖默认行为，或者使用分配操作手动指定分配规则。